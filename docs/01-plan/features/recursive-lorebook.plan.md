# Plan: 재귀 로어북 스캐닝 (Recursive Lorebook Scanning)

## 1. 문제 정의

### 현재 상태
- `filterActiveLorebookEntries()`가 단순 1회 키워드 매칭만 수행
- 활성화된 로어북 항목의 content 안에 다른 로어북의 키워드가 있어도 연쇄 활성화 안 됨
- 예: "마법학교" 로어북이 활성화 → content에 "어둠의 마법" 언급 → "어둠의 마법" 로어북은 미활성화
- 세계관이 복잡할수록 상호 참조되는 설정이 많아 정보 누락 발생

### 목표
1. **연쇄 활성화**: 활성화된 로어북 content를 스캔 텍스트에 추가하여 추가 항목 발견
2. **무한 루프 방지**: 이미 활성화된 항목은 재검사하지 않음
3. **깊이 제한**: 최대 재귀 깊이 3 (대화→1차→2차→3차)
4. **maxEntries 유지**: 최종 결과에서 우선순위 기반 상위 N개만 반환
5. **기존 조건 보존**: minIntimacy, minTurns, requiredCharacter 조건 그대로 적용

## 2. 요구사항

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| R1 | 활성화된 항목의 content를 스캔 텍스트에 누적 | 필수 |
| R2 | 이미 활성화된 항목 중복 방지 (Set 기반) | 필수 |
| R3 | 최대 재귀 깊이 3 | 필수 |
| R4 | 기존 조건 (친밀도/턴/캐릭터) 유지 | 필수 |
| R5 | 우선순위 정렬 + maxEntries 제한 유지 | 필수 |

## 3. 영향 분석

### 수정 파일 (1개)
| 파일 | 변경 내용 |
|------|-----------|
| `src/lib/prompt-builder.ts` | `filterActiveLorebookEntries()` 내부 로직을 재귀 스캔으로 교체 |

### DB 스키마 변경: 없음
### route.ts 변경: 없음 (동일 함수 시그니처 유지)

## 4. 성능 예측

| 항목 | 설명 |
|------|------|
| 실행 빈도 | 매 턴 1회 (기존과 동일) |
| 소요 시간 | +1~3ms (문자열 매칭 3회 반복, 로어북 수십 개 수준) |
| 품질 향상 | 상호 참조되는 세계관 설정이 자동으로 연쇄 활성화 |
