# Plan: 선별적 대화 히스토리 주입 (Selective Conversation History)

## 1. 문제 정의

### 현재 상태
- DB에서 최근 30개 메시지를 **무조건 전부** 가져와서 프롬프트에 주입
- `formatConversationHistory()`: 50k 토큰 한도 내에서 최신→과거 순으로 포함
- 30개 메시지 중 현재 대화 맥락과 무관한 메시지도 모두 포함 → 토큰 낭비
- 30개를 넘은 과거 대화는 sessionSummary로만 접근 가능 → 구체적 맥락 소실

### 목표
- **즉시 컨텍스트** (최근 8개): 대화 흐름 유지 — 항상 포함
- **관련 히스토리 검색** (과거): 현재 유저 메시지와 의미적으로 유사한 과거 대화 선별 포함
- **세션 요약** (장기): 전체 맥락 파악 — 기존 유지
- 결과: 토큰 절약 + 맥락 품질 향상

## 2. 요구사항

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| R1 | Message 모델에 embedding 필드 추가 | 필수 |
| R2 | 유저 메시지 저장 시 임베딩 자동 생성 | 필수 |
| R3 | 현재 메시지 기반 관련 과거 메시지 검색 함수 | 필수 |
| R4 | formatConversationHistory 2단계 분리 (즉시 + 검색) | 필수 |
| R5 | 임베딩 실패 시 기존 방식 폴백 | 필수 |
| R6 | 기존 데이터 무중단 (@default("[]")) | 필수 |

## 3. 데이터 흐름

```
[현재]
DB → 최근 30개 전부 → formatConversationHistory → 프롬프트

[변경 후]
DB → 즉시 컨텍스트 (최근 8개, 항상)
   → 관련 검색 (현재 메시지 임베딩 → 과거 유저 메시지 코사인 유사도 → 상위 5개 + 그 응답)
   → 합체: [관련 과거] + [즉시 컨텍스트] → 프롬프트
```

## 4. 영향 분석

### 수정 파일 (3개)
| 파일 | 변경 내용 |
|------|-----------|
| `prisma/schema.prisma` | Message 모델에 embedding 필드 추가 |
| `src/lib/prompt-builder.ts` | formatConversationHistory 선별적 검색 로직 |
| `src/app/api/chat/route.ts` | 유저 메시지 임베딩 저장 + 선별적 히스토리 빌드 |

## 5. 성능 예측

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 프롬프트 히스토리 | 30개 메시지 전부 | 8개 즉시 + 5쌍 관련 = ~18개 |
| 토큰 사용 | ~15k (히스토리) | ~10k (최적화) |
| 맥락 품질 | 무관한 대화 포함 | 현재 주제 관련 대화만 |
| 추가 지연 | 없음 | 임베딩 생성 ~100ms (병렬) |
