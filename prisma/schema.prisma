// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Vercel Postgres (with connection pooling)
  directUrl = env("DATABASE_POSTGRES_URL_NON_POOLING") // Direct connection for migrations
}

// ============================================================
// NextAuth.js ì¸ì¦ ì‹œìŠ¤í…œ
// ============================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  bio           String?
  birthDate     DateTime?
  gender        String?   @default("private") // male, female, private
  role          String    @default("user") // user, admin

  accounts      Account[]
  sessions      AuthSession[]
  chatSessions  ChatSession[]
  workLikes     WorkLike[]
  workComments  WorkComment[]
  commentLikes  CommentLike[]
  notifications Notification[]
  works         Work[]
  followers     Follow[]  @relation("following") // ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒë“¤
  following     Follow[]  @relation("follower")  // ë‚´ê°€ íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ëŒë“¤
  personas      Persona[] // ìœ ì € í˜ë¥´ì†Œë‚˜ ëª©ë¡

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ìœ ì € í˜ë¥´ì†Œë‚˜ (ëŒ€í™” ì‹œ ì‚¬ìš©í•  ì—­í• )
model Persona {
  id          String   @id @default(uuid())
  userId      String
  name        String   // ë‹‰ë„¤ì„ (ìµœëŒ€ 20ì)
  age         Int?     // ë‚˜ì´
  gender      String   @default("private") // male, female, private
  description String?  // ìƒì„¸ì •ë³´ (ìµœëŒ€ 1000ì)
  isDefault   Boolean  @default(false) // ê¸°ë³¸ í”„ë¡œí•„ ì—¬ë¶€
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// íŒ”ë¡œìš° ê´€ê³„
model Follow {
  id          String   @id @default(uuid())
  followerId  String   // íŒ”ë¡œìš° í•˜ëŠ” ì‚¬ëŒ
  followingId String   // íŒ”ë¡œìš° ë‹¹í•˜ëŠ” ì‚¬ëŒ
  createdAt   DateTime @default(now())

  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model AuthSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================
// ì‘í’ˆ ë° ì½˜í…ì¸ 
// ============================================================

// ì‘í’ˆ ì •ë³´
model Work {
  id             String   @id @default(uuid())
  authorId       String?  // ì‘ì„±ì ID (nullì´ë©´ ì‹œìŠ¤í…œ ì‘í’ˆ)
  title          String   // ì œëª© (ìµœëŒ€ 50ì)
  description    String   // ì†Œê°œ (ìµœëŒ€ 500ì)
  thumbnail      String?  // ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL
  tags           String   @default("[]") // JSON array
  targetAudience String   @default("all") // "all" | "male" | "female"
  visibility     String   @default("private") // "public" | "private" | "unlisted"
  isAdult        Boolean  @default(false)
  worldSetting       String   @default("") // ì„¸ê³„ê´€ ì„¤ì • (ìµœëŒ€ 10000ì)
  relationshipConfig String   @default("{}") // JSON - ì»¤ìŠ¤í…€ ê´€ê³„ ì¶•/ë ˆë²¨ ì„¤ì •
  createdAt          DateTime @default(now())
  updatedAt      DateTime @updatedAt
  publishedAt    DateTime? // ë¡ ì¹­ì¼ (publicìœ¼ë¡œ ì „í™˜í•œ ë‚ ì§œ)

  author       User?       @relation(fields: [authorId], references: [id], onDelete: SetNull)
  characters   Character[]
  lorebook     LorebookEntry[]
  openings     Opening[]
  chatSessions ChatSession[]
  images       GalleryImage[]
  likes        WorkLike[]
  comments     WorkComment[]

  @@index([authorId])
}

// ì•Œë¦¼
model Notification {
  id        String   @id @default(uuid())
  userId    String?  // nullì´ë©´ ì „ì²´ ê³µì§€
  type      String   // "announcement" | "like" | "chat" | "follow" | "comment"
  title     String
  content   String
  link      String?  // í´ë¦­ ì‹œ ì´ë™í•  ê²½ë¡œ
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
}

// ì‘í’ˆ ì¢‹ì•„ìš”
model WorkLike {
  id        String   @id @default(uuid())
  workId    String
  userId    String
  createdAt DateTime @default(now())

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workId, userId])
  @@index([workId])
  @@index([userId])
}

// ì‘í’ˆ ëŒ“ê¸€
model WorkComment {
  id        String   @id @default(uuid())
  workId    String
  userId    String
  content   String   // ëŒ“ê¸€ ë‚´ìš© (ìµœëŒ€ 500ì)
  parentId  String?  // ëŒ€ëŒ“ê¸€ì¸ ê²½ìš° ë¶€ëª¨ ëŒ“ê¸€ ID
  isPinned  Boolean  @default(false) // ê³ ì • ëŒ“ê¸€ ì—¬ë¶€
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  work    Work          @relation(fields: [workId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  WorkComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies WorkComment[] @relation("CommentReplies")
  likes   CommentLike[]

  @@index([workId])
  @@index([userId])
  @@index([parentId])
}

// ëŒ“ê¸€ ì¢‹ì•„ìš”
model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  comment WorkComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

// ìºë¦­í„° ì •ë³´
model Character {
  id           String   @id @default(uuid())
  workId       String
  name         String   // ìºë¦­í„° ì´ë¦„ (ìµœëŒ€ 35ì)
  profileImage String?  // í”„ë¡œí•„ ì´ë¯¸ì§€ URL
  prompt       String   // ìºë¦­í„° í”„ë¡¬í”„íŠ¸ (ìµœëŒ€ 16000ì)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  work          Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  messages      Message[]
  relationships UserCharacterRelationship[]
  memories      CharacterMemory[]

  @@index([workId])
}

// ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
model GalleryImage {
  id            String   @id @default(uuid())
  workId        String
  characterName String?  // nullì´ë©´ ë°°ê²½/ê¸°íƒ€
  keyword       String   // í‚¤ì›Œë“œ (ì˜ë¬¸, ìˆ«ì, ì–¸ë”ë°”)
  imageUrl      String   // ì´ë¯¸ì§€ URL
  description   String?  // ì„¤ëª… (ìµœëŒ€ 100ì)
  createdAt     DateTime @default(now())

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, characterName, keyword])
  @@index([workId])
}

// ë¡œì–´ë¶ í•­ëª©
model LorebookEntry {
  id                String   @id @default(uuid())
  workId            String
  name              String   // ë¡œì–´ ì´ë¦„ (ìµœëŒ€ 80ì)
  keywords          String   // JSON array - í™œì„±í™” í‚¤ì›Œë“œ
  content           String   // ë¡œì–´ ë‚´ìš© (ìµœëŒ€ 4500ì)
  priority          Int      @default(0) // ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë†’ìŒ)
  minIntimacy       Float?   // ìµœì†Œ ì¹œë°€ë„ ì¡°ê±´
  minTurns          Int?     // ìµœì†Œ í„´ ìˆ˜ ì¡°ê±´
  requiredCharacter String?  // ë™ì„ í•„ìš” ìºë¦­í„°
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
}

// ì˜¤í”„ë‹
model Opening {
  id                String   @id @default(uuid())
  workId            String
  title             String   // ì œëª© (ìµœëŒ€ 50ì)
  content           String   // ë‚´ìš© (ìµœëŒ€ 5500ì)
  isDefault         Boolean  @default(false)
  order             Int      @default(0)
  initialLocation   String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ") // ì‹œì‘ ì¥ì†Œ
  initialTime       String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„") // ì‹œì‘ ì‹œê°„
  initialCharacters String   @default("[]") // JSON array - ì˜¤í”„ë‹ ì‹œì‘ ì‹œ ë“±ì¥í•˜ëŠ” ìºë¦­í„° ì´ë¦„ë“¤
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
}

// ì±„íŒ… ì„¸ì…˜
model ChatSession {
  id                String   @id @default(uuid())
  workId            String
  userId            String?  // ë¡œê·¸ì¸í•œ ìœ ì € ID (nullì´ë©´ ë¹„ë¡œê·¸ì¸)
  userName          String   @default("ìœ ì €")
  intimacy          Float    @default(0) // ì¹œë°€ë„
  turnCount         Int      @default(0) // ëŒ€í™” í„´ ìˆ˜
  currentLocation   String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ") // í˜„ì¬ ì¥ì†Œ
  currentTime       String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„") // í˜„ì¬ ì‹œê°„
  presentCharacters String   @default("[]") // JSON array - í˜„ì¬ ì¥ë©´ì— ìˆëŠ” ìºë¦­í„°ë“¤
  recentEvents      String   @default("[]") // JSON array - ìµœê·¼ ì‚¬ê±´ë“¤ (ë§¥ë½ ìœ ì§€ìš©)

  // ğŸ§  ì¥ê¸° ê¸°ì–µ ì‹œìŠ¤í…œ (í™•ì¥)
  userProfile       String   @default("{}") // JSON - ìœ ì € í”„ë¡œí•„ (ì„ í˜¸ë„, ê°œì¸ì •ë³´, ê´€ê³„ ë“±)
  sessionSummary    String   @default("") // ì„¸ì…˜ ìš”ì•½ (ì¤‘ìš” ì´ë²¤íŠ¸, ê´€ê³„ ë³€í™”)
  relationshipStage String   @default("stranger") // ê´€ê³„ ë‹¨ê³„: stranger, acquaintance, friend, close_friend, intimate
  characterMemories String   @default("{}") // JSON - ìºë¦­í„°ë³„ ìœ ì €ì— ëŒ€í•œ ê¸°ì–µ

  // ğŸ‘¤ ìœ ì € í˜ë¥´ì†Œë‚˜ (ìºë¦­í„°ë“¤ì´ ì¸ì§€í•  ìœ ì € ì •ë³´)
  userPersona       String   @default("{}") // JSON - {name, age, gender, description}

  // ğŸ¤– Pro ë¶„ì„ ê²°ê³¼ (í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜)
  proAnalysis       String   @default("") // Proê°€ ë¶„ì„í•œ ë””ë ‰í„° ë…¸íŠ¸ (ë‹¤ìŒ í„´ Flashê°€ ì°¸ì¡°)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work     Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  messages Message[]

  @@index([workId])
  @@index([userId])
}

// ë©”ì‹œì§€
model Message {
  id          String   @id @default(uuid())
  sessionId   String
  characterId String?  // nullì´ë©´ ìœ ì € ë©”ì‹œì§€, 'narrator'ë©´ ë‚˜ë ˆì´ì…˜
  content     String
  messageType String   @default("dialogue") // "dialogue" | "narrator" | "user" | "system"
  imageUrl    String?  // AI ìƒì„± ìƒí™© ì´ë¯¸ì§€ URL
  metadata    String?  // JSON - AI ì‘ë‹µ ë©”íƒ€ë°ì´í„° (ê´€ë¦¬ììš©)
  embedding   String   @default("[]") // 256ì°¨ì› ì„ë² ë”© ë²¡í„° (ìœ ì € ë©”ì‹œì§€, ì„ ë³„ì  íˆìŠ¤í† ë¦¬ ê²€ìƒ‰ìš©)
  createdAt   DateTime @default(now())

  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character?  @relation(fields: [characterId], references: [id], onDelete: SetNull)

  @@index([sessionId, createdAt])
  @@index([sessionId])
  @@index([characterId])
}

// ìƒì„±ëœ ì´ë¯¸ì§€ ìºì‹œ (ë¹„ìš© ì ˆê°ìš©)
model GeneratedImageCache {
  id              String   @id @default(uuid())
  characterId     String   // ìºë¦­í„° ID
  promptHash      String   // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ í•´ì‹œ (ì¤‘ë³µ ë°©ì§€)
  imageUrl        String   // ìƒì„±ëœ ì´ë¯¸ì§€ URL
  imagePrompt     String   // ì›ë³¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸
  createdAt       DateTime @default(now())
  expiresAt       DateTime // ìºì‹œ ë§Œë£Œ ì‹œê°„

  @@unique([characterId, promptHash])
  @@index([characterId])
  @@index([promptHash])
}

// ============================================================
// ğŸ§  ì„œì‚¬ ì§€ì†í˜• ì¥ê¸° ê¸°ì–µ ì‹œìŠ¤í…œ (Narrative Memory System)
// ============================================================
// ëª©í‘œ: ì •ë³´ ê¸°ì–µì´ ì•„ë‹ˆë¼, ìœ ì €ì™€ ìºë¦­í„° ê°„ì˜ ì„œì‚¬ì  ê´€ê³„ ìƒíƒœë¥¼
// ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë©°, ìºë¦­í„° ì„±ê²©ì— ë”°ë¼ ë™ì¼ ì‚¬ê±´ì„
// ë‹¤ë¥´ê²Œ í•´ì„Â·ê¸°ì–µí•˜ëŠ” ë‹¤ì¤‘ ì‹œì  ì¥ê¸° ë©”ëª¨ë¦¬ êµ¬ì¡°
// ============================================================

// ì›ë³¸ ëŒ€í™” ê¸°ë¡ (ëª¨ë“  ëŒ€í™” ì›ë¬¸ ë³´ê´€ - ë°ì´í„° ì†Œìœ ê¶Œ í™•ë³´)
model ConversationLog {
  id          String   @id @default(uuid())
  sessionId   String   // ì±„íŒ… ì„¸ì…˜ ID

  // ëŒ€í™” ì°¸ì—¬ì
  speakerType String   // "user" | "character" | "narrator"
  speakerId   String?  // ìºë¦­í„° ID (user/narratorëŠ” null)
  speakerName String   // í‘œì‹œ ì´ë¦„

  // ëŒ€í™” ë‚´ìš©
  content     String   // ì›ë³¸ ë©”ì‹œì§€ (ì™„ì „í•œ ì›ë¬¸)

  // ë©”íƒ€ë°ì´í„°
  sceneId     String?  // ì—°ê²°ëœ Scene ID
  emotionTag  String?  // ê°ì • íƒœê·¸ (JSON: {primary, intensity})

  createdAt   DateTime @default(now())

  scene       Scene?   @relation(fields: [sceneId], references: [id])

  @@index([sessionId, createdAt])
  @@index([sessionId])
  @@index([sceneId])
  @@index([speakerId])
}

// ì¥ë©´ (Scene) - ì„œì‚¬ ë‹¨ìœ„ ê¸°ì–µì˜ í•µì‹¬
// ê¸°ì–µì˜ ë‹¨ìœ„ëŠ” "ì‚¬ì‹¤"ì´ ì•„ë‹ˆë¼ "ìƒí™©(Scene)"
model Scene {
  id          String   @id @default(uuid())
  sessionId   String   // ì±„íŒ… ì„¸ì…˜ ID

  // ì¥ë©´ ì •ë³´
  location    String   // ì¥ì†Œ (ì˜ˆ: "ì¹´í˜", "ê³µì›")
  time        String   // ì‹œê°„ (ì˜ˆ: "ì˜¤í›„", "ë°¤")

  // ì°¸ì—¬ì (JSON array of character IDs)
  participants String  @default("[]")

  // ì¥ë©´ ìš”ì•½ (AIê°€ ìƒì„±)
  summary     String?  // ì´ ì¥ë©´ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆëŠ”ì§€ ìš”ì•½

  // ì¥ë©´ì˜ ê°ì • í†¤ (JSON)
  // {mood: "ë”°ëœ»í•¨", intensity: 0.7, keywords: ["í¸ì•ˆ", "ì¹œë°€"]}
  emotionalTone String @default("{}")

  // ì£¼ìš” ì‚¬ê±´/í† í”½ (JSON array)
  // ["ê°•ì•„ì§€ ì´ì•¼ê¸°", "ì·¨ë¯¸ ê³µìœ ", "ë†ë‹´"]
  topics      String   @default("[]")

  // ì¥ë©´ ì‹œì‘/ì¢…ë£Œ
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  isActive    Boolean  @default(true) // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¥ë©´

  // ê´€ê³„ ë³€í™” (ì´ ì¥ë©´ìœ¼ë¡œ ì¸í•œ)
  relationshipChanges RelationshipChange[]
  characterMemories   CharacterMemory[]
  conversationLogs    ConversationLog[]

  @@index([sessionId, isActive])
  @@index([sessionId])
  @@index([isActive])
}

// ìœ ì €-ìºë¦­í„° ê´€ê³„ ìƒíƒœ (User â†” Character)
// ë™ì  ê´€ê³„ ê·¸ë˜í”„ì˜ í•µì‹¬ ë…¸ë“œ
model UserCharacterRelationship {
  id          String   @id @default(uuid())
  sessionId   String   // ì±„íŒ… ì„¸ì…˜ ID
  characterId String   // ìºë¦­í„° ID

  // ğŸ”„ í¬ë¡œìŠ¤ì„¸ì…˜ ë©”ëª¨ë¦¬ (userId+workIdë¡œ ì„¸ì…˜ ë„˜ì–´ ê´€ê³„ ìœ ì§€)
  userId      String?  // ìœ ì € ID (í¬ë¡œìŠ¤ì„¸ì…˜ ì‹ë³„)
  workId      String?  // ì‘í’ˆ ID (í¬ë¡œìŠ¤ì„¸ì…˜ ì‹ë³„)

  // === ê´€ê³„ ìƒíƒœ ===
  // ì¹œë°€ë„ ë ˆë²¨: stranger â†’ acquaintance â†’ friend â†’ close_friend â†’ intimate
  intimacyLevel  String  @default("stranger")
  intimacyScore  Float   @default(0)  // 0.0 ~ 100.0

  // === ë‹¤ì¶• ê´€ê³„ ê·¸ë˜í”„ (Multi-Axis) ===
  trust       Float @default(50)  // ì‹ ë¢°ë„: ì•½ì†/ë¹„ë°€ ì´í–‰ (0-100)
  affection   Float @default(30)  // í˜¸ê°ë„: ì •ì„œì  ì¹œë°€ê° (0-100)
  respect     Float @default(50)  // ì¡´ê²½ë„: ëŠ¥ë ¥/ì¸í’ˆ ì¸ì • (0-100)
  rivalry     Float @default(10)  // ê²½ìŸì‹¬: ëŒ€ë¦½/ë¼ì´ë²Œ ì˜ì‹ (0-100)
  familiarity Float @default(0)   // ì¹œìˆ™ë„: í•¨ê»˜í•œ ê²½í—˜ëŸ‰ (0-100)

  // ê´€ê³„ ìœ í˜• (ìºë¦­í„°ê°€ ìœ ì €ë¥¼ ì–´ë–»ê²Œ ë³´ëŠ”ê°€)
  // "ë™ë¬¼ ì¢‹ì•„í•˜ëŠ” ë”°ëœ»í•œ ì‚¬ëŒ", "ì¥ë‚œê¾¸ëŸ¬ê¸°", "ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¹œêµ¬"
  relationshipLabel String?

  // === ìƒí˜¸ì‘ìš© í†µê³„ ===
  totalTurns      Int     @default(0)  // ì´ ëŒ€í™” í„´ ìˆ˜
  totalScenes     Int     @default(0)  // í•¨ê»˜í•œ ì¥ë©´ ìˆ˜
  lastInteraction DateTime?            // ë§ˆì§€ë§‰ ìƒí˜¸ì‘ìš©

  // === ëŒ€í™” ìŠ¤íƒ€ì¼ ===
  speechStyle     String  @default("formal") // formal | casual | intimate
  nicknameForUser String? // ìºë¦­í„°ê°€ ìœ ì €ë¥¼ ë¶€ë¥´ëŠ” ë³„ëª…

  // === ê°ì • ê¸°ë¡ ===
  // ìºë¦­í„°ê°€ ìœ ì €ì—ê²Œ ëŠë¼ëŠ” ê°ì •ë“¤ (JSON array)
  // [{emotion: "í˜¸ê°", intensity: 0.6, since: "2025-01-01"}]
  emotionalHistory String @default("[]")

  // === ê³µìœ ëœ ê²½í—˜ ===
  // í•¨ê»˜ ê²ªì€ ì¤‘ìš”í•œ ì‚¬ê±´ë“¤ (JSON array of scene summaries)
  sharedExperiences String @default("[]")

  // === ìºë¦­í„°ê°€ ì•„ëŠ” ìœ ì € ì •ë³´ ===
  // ì´ ìºë¦­í„°ë§Œ ì•Œê³  ìˆëŠ” ìœ ì € ì •ë³´ (ë‹¤ë¥¸ ìºë¦­í„°ëŠ” ëª¨ë¦„)
  knownFacts String @default("[]") // JSON array

  // ì»¤ìŠ¤í…€ ì¶• ê°’ (JSON - Record<string, number>)
  customAxes  String @default("{}")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  changes     RelationshipChange[]

  @@unique([sessionId, characterId])
  @@unique([userId, workId, characterId])
  @@index([sessionId])
  @@index([characterId])
  @@index([userId, workId])
}

// ê´€ê³„ ë³€í™” ê¸°ë¡ (Sceneìœ¼ë¡œ ì¸í•œ ë³€í™”)
model RelationshipChange {
  id             String   @id @default(uuid())
  relationshipId String   // UserCharacterRelationship ID
  sceneId        String   // ë³€í™”ê°€ ë°œìƒí•œ Scene ID

  // ë³€í™” ë‚´ìš©
  changeType     String   // "intimacy_up" | "intimacy_down" | "label_change" | "emotion_change"
  previousValue  String?  // ì´ì „ ê°’
  newValue       String?  // ìƒˆ ê°’

  // ë³€í™” ì´ìœ  (AIê°€ ìƒì„±)
  reason         String?  // "ìœ ì €ê°€ ì§„ì‹¬ì–´ë¦° ìœ„ë¡œë¥¼ í•´ì¤Œ"

  createdAt      DateTime @default(now())

  relationship   UserCharacterRelationship @relation(fields: [relationshipId], references: [id], onDelete: Cascade)
  scene          Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([relationshipId])
  @@index([sceneId])
}

// ìºë¦­í„°ë³„ ê¸°ì–µ (ìºë¦­í„° ì„±ê²© í•„í„°ë¡œ í•´ì„ëœ ê¸°ì–µ)
// ê°™ì€ ì‚¬ê±´ì„ ìºë¦­í„°ë³„ë¡œ ë‹¤ë¥´ê²Œ ê¸°ì–µ
model CharacterMemory {
  id          String   @id @default(uuid())
  sessionId   String   // ì±„íŒ… ì„¸ì…˜ ID
  characterId String   // ê¸°ì–µí•˜ëŠ” ìºë¦­í„°
  sceneId     String?  // ê´€ë ¨ ì¥ë©´ (ì„ íƒ)

  // ğŸ”„ í¬ë¡œìŠ¤ì„¸ì…˜ ë©”ëª¨ë¦¬
  userId      String?  // ìœ ì € ID (í¬ë¡œìŠ¤ì„¸ì…˜ ì‹ë³„)
  workId      String?  // ì‘í’ˆ ID (í¬ë¡œìŠ¤ì„¸ì…˜ ì‹ë³„)

  // === ê¸°ì–µ ë‚´ìš© ===
  // ì›ë³¸ ì‚¬ê±´
  originalEvent String  // "ìœ ì €ê°€ ì¹´í˜ì—ì„œ ê°•ì•„ì§€ ì´ì•¼ê¸°ë¥¼ í•˜ë©° ì›ƒìŒ"

  // ìºë¦­í„° í•´ì„ (ì„±ê²© í•„í„° ì ìš©)
  // A: "ìœ ì € ë‚˜í•œí…Œ í¸í•´ì¡Œë„¤ ğŸ˜Š"
  // B: "ë‚˜ë‘ ìˆì„ ë• ì˜ ì•ˆ ì›ƒëŠ”ë°â€¦"
  interpretation String

  // ê°ì • ë°˜ì‘
  emotionalResponse String? // JSON: {emotion: "ê¸°ì¨", intensity: 0.7}

  // === ê¸°ì–µ ë©”íƒ€ë°ì´í„° ===
  memoryType  String   @default("episodic") // episodic(ì¼í™”) | semantic(ì‚¬ì‹¤) | emotional(ê°ì •)
  importance  Float    @default(0.5) // 0.0 ~ 1.0 (ì¤‘ìš”ë„)

  // ê¸°ì–µ ê°•ë„ (ì‹œê°„ì´ ì§€ë‚˜ë©´ ê°ì†Œ ê°€ëŠ¥)
  strength    Float    @default(1.0) // 0.0 ~ 1.0

  // ì—°ê´€ í‚¤ì›Œë“œ (ê²€ìƒ‰ìš©)
  keywords    String   @default("[]") // JSON array

  // ì„ë² ë”© ë²¡í„° (ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ìš©, 256ì°¨ì›)
  embedding   String   @default("[]") // JSON: Float[]

  // ì´ ê¸°ì–µì„ ì–¸ê¸‰í–ˆëŠ”ì§€
  mentionedCount Int   @default(0)
  lastMentioned  DateTime?

  createdAt   DateTime @default(now())

  scene       Scene?   @relation(fields: [sceneId], references: [id])
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([sessionId, characterId, memoryType])
  @@index([sessionId])
  @@index([characterId])
  @@index([sceneId])
  @@index([memoryType])
  @@index([userId, workId, characterId, memoryType])
}

// ============================================================
// ìš´ì˜ì ê´€ë¦¬ ì‹œìŠ¤í…œ
// ============================================================

// ë°°ë„ˆ ê´€ë¦¬
model Banner {
  id          String    @id @default(uuid())
  title       String    // ë°°ë„ˆ ì œëª© (ê´€ë¦¬ìš©)
  imageUrl    String    // ë°°ë„ˆ ì´ë¯¸ì§€ URL
  linkUrl     String?   // í´ë¦­ ì‹œ ì´ë™í•  URL
  order       Int       @default(0) // ë…¸ì¶œ ìˆœì„œ
  isActive    Boolean   @default(true)
  startDate   DateTime? // ë…¸ì¶œ ì‹œì‘ì¼
  endDate     DateTime? // ë…¸ì¶œ ì¢…ë£Œì¼
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ê³µì§€ì‚¬í•­
model Announcement {
  id          String    @id @default(uuid())
  title       String    // ê³µì§€ ì œëª©
  content     String    // ê³µì§€ ë‚´ìš©
  type        String    @default("normal") // normal, important, maintenance
  isPinned    Boolean   @default(false) // ìƒë‹¨ ê³ ì •
  isActive    Boolean   @default(true)
  viewCount   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ì‹ ê³  ê´€ë¦¬
model Report {
  id          String    @id @default(uuid())
  reporterId  String?   // ì‹ ê³ ì ID
  targetType  String    // work, user, chat
  targetId    String    // ì‹ ê³  ëŒ€ìƒ ID
  reason      String    // ì‹ ê³  ì‚¬ìœ 
  description String?   // ìƒì„¸ ì„¤ëª…
  status      String    @default("pending") // pending, reviewing, resolved, rejected
  adminNote   String?   // ê´€ë¦¬ì ë©”ëª¨
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([targetType])
  @@index([status])
}

// ì‚¬ì´íŠ¸ ì„¤ì •
model SiteSetting {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String
  description String?
  updatedAt   DateTime  @updatedAt
}
