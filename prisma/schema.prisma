// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ì‘í’ˆ ì •ë³´
model Work {
  id             String   @id @default(uuid())
  title          String   // ì œëª© (ìµœëŒ€ 50ì)
  description    String   // ì†Œê°œ (ìµœëŒ€ 500ì)
  thumbnail      String?  // ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL
  tags           String   @default("[]") // JSON array
  targetAudience String   @default("all") // "all" | "male" | "female"
  visibility     String   @default("private") // "public" | "private" | "unlisted"
  isAdult        Boolean  @default(false)
  worldSetting   String   @default("") // ì„¸ê³„ê´€ ì„¤ì • (ìµœëŒ€ 10000ì)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  characters   Character[]
  lorebook     LorebookEntry[]
  openings     Opening[]
  chatSessions ChatSession[]
  images       GalleryImage[]
}

// ìºë¦­í„° ì •ë³´
model Character {
  id           String   @id @default(uuid())
  workId       String
  name         String   // ìºë¦­í„° ì´ë¦„ (ìµœëŒ€ 35ì)
  profileImage String?  // í”„ë¡œí•„ ì´ë¯¸ì§€ URL
  prompt       String   // ìºë¦­í„° í”„ë¡¬í”„íŠ¸ (ìµœëŒ€ 16000ì)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  work     Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([workId])
}

// ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
model GalleryImage {
  id            String   @id @default(uuid())
  workId        String
  characterName String?  // nullì´ë©´ ë°°ê²½/ê¸°íƒ€
  keyword       String   // í‚¤ì›Œë“œ (ì˜ë¬¸, ìˆ«ì, ì–¸ë”ë°”)
  imageUrl      String   // ì´ë¯¸ì§€ URL
  description   String?  // ì„¤ëª… (ìµœëŒ€ 100ì)
  createdAt     DateTime @default(now())

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, characterName, keyword])
  @@index([workId])
}

// ë¡œì–´ë¶ í•­ëª©
model LorebookEntry {
  id                String   @id @default(uuid())
  workId            String
  name              String   // ë¡œì–´ ì´ë¦„ (ìµœëŒ€ 80ì)
  keywords          String   // JSON array - í™œì„±í™” í‚¤ì›Œë“œ
  content           String   // ë¡œì–´ ë‚´ìš© (ìµœëŒ€ 4500ì)
  priority          Int      @default(0) // ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ë†’ìŒ)
  minIntimacy       Float?   // ìµœì†Œ ì¹œë°€ë„ ì¡°ê±´
  minTurns          Int?     // ìµœì†Œ í„´ ìˆ˜ ì¡°ê±´
  requiredCharacter String?  // ë™ì„ í•„ìš” ìºë¦­í„°
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
}

// ì˜¤í”„ë‹
model Opening {
  id                String   @id @default(uuid())
  workId            String
  title             String   // ì œëª© (ìµœëŒ€ 50ì)
  content           String   // ë‚´ìš© (ìµœëŒ€ 5500ì)
  isDefault         Boolean  @default(false)
  order             Int      @default(0)
  initialLocation   String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ") // ì‹œì‘ ì¥ì†Œ
  initialTime       String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„") // ì‹œì‘ ì‹œê°„
  initialCharacters String   @default("[]") // JSON array - ì˜¤í”„ë‹ ì‹œì‘ ì‹œ ë“±ì¥í•˜ëŠ” ìºë¦­í„° ì´ë¦„ë“¤
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
}

// ì±„íŒ… ì„¸ì…˜
model ChatSession {
  id                String   @id @default(uuid())
  workId            String
  userName          String   @default("ìœ ì €")
  intimacy          Float    @default(0) // ì¹œë°€ë„
  turnCount         Int      @default(0) // ëŒ€í™” í„´ ìˆ˜
  currentLocation   String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ") // í˜„ì¬ ì¥ì†Œ
  currentTime       String   @default("ì•Œ ìˆ˜ ì—†ëŠ” ì‹œê°„") // í˜„ì¬ ì‹œê°„
  presentCharacters String   @default("[]") // JSON array - í˜„ì¬ ì¥ë©´ì— ìˆëŠ” ìºë¦­í„°ë“¤
  recentEvents      String   @default("[]") // JSON array - ìµœê·¼ ì‚¬ê±´ë“¤ (ë§¥ë½ ìœ ì§€ìš©)

  // ğŸ§  ì¥ê¸° ê¸°ì–µ ì‹œìŠ¤í…œ (í™•ì¥)
  userProfile       String   @default("{}") // JSON - ìœ ì € í”„ë¡œí•„ (ì„ í˜¸ë„, ê°œì¸ì •ë³´, ê´€ê³„ ë“±)
  sessionSummary    String   @default("") // ì„¸ì…˜ ìš”ì•½ (ì¤‘ìš” ì´ë²¤íŠ¸, ê´€ê³„ ë³€í™”)
  relationshipStage String   @default("stranger") // ê´€ê³„ ë‹¨ê³„: stranger, acquaintance, friend, close_friend, intimate
  characterMemories String   @default("{}") // JSON - ìºë¦­í„°ë³„ ìœ ì €ì— ëŒ€í•œ ê¸°ì–µ

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  work     Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([workId])
}

// ë©”ì‹œì§€
model Message {
  id          String   @id @default(uuid())
  sessionId   String
  characterId String?  // nullì´ë©´ ìœ ì € ë©”ì‹œì§€, 'narrator'ë©´ ë‚˜ë ˆì´ì…˜
  content     String
  messageType String   @default("dialogue") // "dialogue" | "narrator" | "user" | "system"
  imageUrl    String?  // AI ìƒì„± ìƒí™© ì´ë¯¸ì§€ URL
  createdAt   DateTime @default(now())

  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  character Character?  @relation(fields: [characterId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([characterId])
}

// ìƒì„±ëœ ì´ë¯¸ì§€ ìºì‹œ (ë¹„ìš© ì ˆê°ìš©)
model GeneratedImageCache {
  id              String   @id @default(uuid())
  characterId     String   // ìºë¦­í„° ID
  promptHash      String   // ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ í•´ì‹œ (ì¤‘ë³µ ë°©ì§€)
  imageUrl        String   // ìƒì„±ëœ ì´ë¯¸ì§€ URL
  imagePrompt     String   // ì›ë³¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸
  createdAt       DateTime @default(now())
  expiresAt       DateTime // ìºì‹œ ë§Œë£Œ ì‹œê°„

  @@unique([characterId, promptHash])
  @@index([characterId])
  @@index([promptHash])
}
